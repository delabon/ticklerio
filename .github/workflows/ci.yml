name: "CI"

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
    paths:
      - "app/src/**.php"
      - "app/phpcs.xml"
      - ".github/workflows/ci.yml"
jobs:

  phpcs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0 # important!

      # we may use whatever way to install phpcs, just specify the path on the next step
      # however, curl seems to be the fastest
      - name: Install PHP_CodeSniffer
        run: |
          curl -OL https://squizlabs.github.io/PHP_CodeSniffer/phpcs.phar
          php phpcs.phar --version

      - uses: tinovyatkin/action-php-codesniffer@v1
        with:
          files: "app/src/**.php" # you may customize glob as needed
          phpcs_path: php phpcs.phar
          standard: app/phpcs.xml

  app-tests:

    runs-on: ubuntu-latest

    steps:
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
      - uses: actions/checkout@v3

      - name: Copy .env
        run: php -r "copy('app/.env.testing.example', 'app/.env');"

      - name: Install Dependencies
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
        working-directory: app

      - name: Start PHP server
        run: php -S localhost:8000 -t public &
        working-directory: app

      - name: Execute tests (Unit and Feature tests) via PHPUnit
        env:
          BASE_URL: http://localhost:8000
        run: vendor/bin/phpunit
        working-directory: app
